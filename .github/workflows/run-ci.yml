name: Rust CI Core

on:
  workflow_call:
  workflow_dispatch:

jobs:
  rust_ci:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Free up disk space
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo apt-get clean
          echo "After cleanup:"
          df -h

      # Step 3: Install essential dependencies including protobuf-compiler and dbus
      - name: Install essential dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose jq curl lsb-release protobuf-compiler libdbus-1-dev pkg-config build-essential

      # Step 4: Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Step 5: Make all scripts executable
      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      # Step 6: Install Rust project dependencies
      - name: Install project dependencies
        run: ./scripts/installdeps.sh

      # Step 6.5: Setup RocksDB shared storage directory
      - name: Setup RocksDB storage directory
        run: |
          mkdir -p /tmp/pullpiri_shared_rocksdb
          # Make directory writable by all users (container needs write access)
          chmod 777 /tmp/pullpiri_shared_rocksdb
          echo "âœ… RocksDB storage directory created at /tmp/pullpiri_shared_rocksdb"

      # Step 5.6: Start RocksDB service container for testing
      - name: Start RocksDB service container
        run: |
          docker run -d \
            --name rocksdb-test-service \
            -p 47007:47007 \
            -v /tmp/pullpiri_shared_rocksdb:/data \
            -e RUST_LOG=info \
            ghcr.io/mco-piccolo/pullpiri-rocksdb:v11.18.0 \
            rocksdbservice --path /data --addr 0.0.0.0 --port 47007
          echo "âœ… RocksDB service container started on port 47007"

      # Step 5.7: Wait for RocksDB service to be ready
      - name: Wait for RocksDB service to be ready
        run: |
          echo "â³ Waiting for RocksDB service to be ready..."
          for i in {1..30}; do
            if docker logs rocksdb-test-service 2>&1 | grep -q "RocksDB gRPC Service starting"; then
              echo "âœ… RocksDB service is ready!"
              docker logs rocksdb-test-service
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ RocksDB service failed to start!"
              docker logs rocksdb-test-service
              exit 1
            fi
            echo "  Attempt $i/30: Still waiting..."
            sleep 2
          done
          # Set environment variable for subsequent steps
          echo "ROCKSDB_SERVICE_URL=http://localhost:47007" >> $GITHUB_ENV

      # Step 6: Create output folders for reports
      - name: Create reports directory
        run: |
          mkdir -p dist/reports/fmt
          mkdir -p dist/reports/deny
          mkdir -p dist/tests
          mkdir -p dist/licenses
          mkdir -p dist/coverage
          mkdir -p dist/coverage/common
          mkdir -p dist/coverage/server
          mkdir -p dist/coverage/player
          mkdir -p dist/coverage/tools
          mkdir -p dist/coverage/agent
          mkdir -p dist/binaries

      # Step 7: Run project build and parse logs
      - name: Build and parse project
        run: ./scripts/buildNparse.sh

      # Step 7.5: Add musl target for static linking
      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl

      # Step 8: Build nodeagent binary for release (x86_64 only)
      - name: Build nodeagent binary (x86_64 static)
        run: |
          echo "Building nodeagent (static) from src/agent/nodeagent directory..."
          cd src/agent/nodeagent
          cargo build --release --target x86_64-unknown-linux-musl
          cd ../../../
          mkdir -p dist/binaries/amd/
          cp src/agent/nodeagent/target/x86_64-unknown-linux-musl/release/nodeagent dist/binaries/amd/nodeagent-linux-amd64
          ls -la dist/binaries/amd/
          file dist/binaries/amd/nodeagent-linux-amd64

      # Step 9: Upload nodeagent binary
      - name: Upload nodeagent binary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nodeagent-binary-amd64
          path: dist/binaries/amd/nodeagent-linux-amd64

      # Step 10: Run all Rust unit/integration tests and generate reports
      - name: Run tests and generate report
        env:
          ROCKSDB_SERVICE_URL: http://localhost:47007
        run: ./scripts/testNparse.sh

      # Step 11: Linting (clippy)
      - name: Run Clippy (lint)
        run: ./scripts/clippy_check.sh

      # Step 12: Formatting check
      - name: Run format check
        run: ./scripts/fmt_check.sh

      # Step 13: License, ban, and security checks with cargo-deny
      - name: Run cargo-deny checks
        run: ./scripts/deny_check.sh

      # Step 14: Run test coverage script
      - name: Run test coverage script
        env:
          ROCKSDB_SERVICE_URL: http://localhost:47007
        run: ./scripts/test_coverage.sh

      # Step 14.5: Cleanup RocksDB service container
      - name: Stop and remove RocksDB service
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up RocksDB service..."
          docker stop rocksdb-test-service || true
          docker rm rocksdb-test-service || true
          echo "âœ… RocksDB service cleaned up"

      # === Upload All Reports ===

      # Step 15: Upload deny report
      - name: Upload deny report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deny-report
          path: dist/reports/deny/deny_summary.md

      # Step 16: Upload format report
      - name: Upload fmt report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fmt-report
          path: dist/reports/fmt/fmt_summary.md

      # Step 16-2: Upload clippy report
      - name: Upload clippy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clippy-report
          path: dist/reports/clippy/clippy_summary.md

      # Step 17: Upload all test reports (JUnit-style)
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: dist/tests/*

      # Step 18: Upload test coverage reports
      - name: Upload Overall coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: dist/coverage/*

      - name: Upload coverage report for server (lcov)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-lcov-server
          path: dist/coverage/server/lcov.info

      - name: Upload coverage report for server (xml)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-xml-server
          path: dist/coverage/server/cobertura.xml

      - name: Upload coverage report for server (html)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-html-server
          path: dist/coverage/server/tarpaulin-report-server.html

      - name: Upload coverage report for tools (lcov)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-lcov-tools
          path: dist/coverage/tools/lcov.info

      - name: Upload coverage report for tools (xml)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-xml-tools
          path: dist/coverage/tools/cobertura.xml

      - name: Upload coverage report for tools (html)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-html-tools
          path: dist/coverage/tools/tarpaulin-report-tools.html

      - name: Upload coverage report for common (lcov)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-lcov-common
          path: dist/coverage/common/lcov.info

      - name: Upload coverage report for common (xml)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-xml-common
          path: dist/coverage/common/cobertura.xml

      - name: Upload coverage report for common (html)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-html-common
          path: dist/coverage/common/tarpaulin-report-common.html

      #Test Cases are not proper and passing so code coverage report will not generate as of now
      # - name: Upload coverage report for agent (lcov)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-lcov-agent
      #     path: dist/coverage/agent/lcov.info

      # - name: Upload coverage report for agent (xml)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-xml-agent
      #     path: dist/coverage/agent/cobertura.xml
    
      # - name: Upload coverage report for agent (html)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-html-agent
      #     path: dist/coverage/agent/tarpaulin-report-agent.html
      
      # - name: Upload coverage report for player (lcov)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-lcov-player
      #     path: dist/coverage/player/lcov.info

      # - name: Upload coverage report for player (xml)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-xml-player
      #     path: dist/coverage/player/cobertura.xml
    
      # - name: Upload coverage report for player (html)
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: code-coverage-html-player
      #     path: dist/coverage/player/tarpaulin-report-player.html
    
      # # Step 17: Upload to Codecov
      # - name: Upload to Codecov
      #   if: env.CODECOV_TOKEN != ''
      #   uses: codecov/codecov-action@v4.0.1
      #   with:
      #     token: ${{ env.CODECOV_TOKEN }}
      #     slug: ${{ github.repository }}
      #     files: dist/coverage/lcov.info

  build_linux_arm64:
    runs-on: ubuntu-22.04-arm
    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install essential dependencies including protobuf-compiler and dbus
      - name: Install essential dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y docker-compose jq curl lsb-release protobuf-compiler libdbus-1-dev pkg-config build-essential

      # Step 3: Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Step 4: Add musl target for static linking
      - name: Add musl target
        run: rustup target add aarch64-unknown-linux-musl

      # Step 5: Build nodeagent binary for ARM64 release
      - name: Build nodeagent binary (ARM64 static)
        run: |
          echo "Building nodeagent (static) from src/agent/nodeagent directory for ARM64..."
          cd src/agent/nodeagent
          cargo build --release --target aarch64-unknown-linux-musl
          cd ../../../
          mkdir -p dist/binaries/arm/
          cp src/agent/nodeagent/target/aarch64-unknown-linux-musl/release/nodeagent dist/binaries/arm/nodeagent-linux-arm64
          ls -la dist/binaries/arm/
          file dist/binaries/arm/nodeagent-linux-arm64
      # Step 6: Upload ARM64 nodeagent binary
      - name: Upload nodeagent binary (ARM64)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nodeagent-binary-arm64
          path: dist/binaries/arm/nodeagent-linux-arm64
